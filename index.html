<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Five Forks ‚Äî Demo (Fuel Moisture)</title>

  <!-- Leaflet CSS for map controls (demo) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:0; }
    header { background:#1d4ed8; color:#fff; padding:1rem; display:flex; align-items:center; gap:1rem; justify-content:space-between; }
    .badge { background:#e0e7ff; color:#08306b; border-radius:6px; padding:.25rem .5rem; cursor:pointer; display:inline-block; }
    main { padding:1rem; display:flex; gap:1rem; }
    .map-wrap { flex:1; min-height:420px; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; position:relative; }
    #map { width:100%; height:100%; min-height:420px; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10010; align-items:center; justify-content:center; }
    .modal-content { background:#fff; color:#000; padding:1rem; max-width:900px; width:95%; max-height:90%; overflow:auto; border-radius:8px; position:relative; }
    .modal-close { position:absolute; right:.5rem; top:.5rem; background:transparent; border:none; font-size:1.2rem; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    td, th { padding:.25rem .5rem; border-bottom:1px solid #eee; }
    #resultsSection { display:none; margin-top:.5rem; }
    .controls { position:absolute; top:.5rem; left:.5rem; z-index:10050; display:flex; gap:.5rem; }
  </style>
</head>
<body>
  <header>
    <div>
      <strong>üî• Five Forks Fire Weather ‚Äî Demo</strong>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center">
      <a href="#" class="badge" style="text-decoration:none">üõ∞Ô∏è FIRMS</a>
      <button id="openFuelCalc" class="badge">üßÆ Fuel Moisture</button>
      <button id="themeToggle" class="badge">üåô Dark</button>
    </div>
  </header>

  <main>
    <section class="map-wrap" aria-label="Hotspots map">
      <div id="map"></div>
      <div class="controls">
        <button id="toggleFires" class="badge">Fires</button>
        <button id="toggleCounties" class="badge">Counties</button>
      </div>
    </section>

    <aside style="width:320px">
      <h3>Status</h3>
      <div id="status" style="background:#f8fafc;border:1px solid #e6eef8;padding:.5rem;border-radius:6px;">
        <div>NOAA: <span id="status-noaa">OK</span></div>
        <div>FIRMS: <span id="status-firms">OK</span></div>
      </div>
    </aside>
  </main>

  <!-- Modal DOM for calculator -->
  <div id="fuelCalcModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="fuelCalcTitle" aria-hidden="true">
    <div class="modal-content">
      <button id="modalCloseBtn" class="modal-close" aria-label="Close modal">‚úñ</button>
      <div id="fuelCalcUI" style="padding-top:1.5rem;">
        <h2 id="fuelCalcTitle" tabindex="-1">Fuel Moisture Calculator</h2>

        <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:0.75rem;">
          <label>Initial 1‚Äëhr: <input id="initial1hr" type="number" value="8" style="width:4rem"></label>
          <label>Initial 10‚Äëhr: <input id="initial10hr" type="number" value="10" style="width:4rem"></label>
        </div>

        <table id="forecastDays" style="width:100%;border-collapse:collapse;margin-bottom:.5rem;"></table>

        <div style="margin-bottom:.5rem;">
          <button id="runModelBtn" class="badge" style="cursor:pointer">Run Model</button>
        </div>

        <div id="resultsSection" style="display:none;">
          <div id="warningMessage" style="color:#b91c1c;margin-bottom:.5rem;display:none"></div>
          <div id="resultsTable" style="overflow:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Calculator script (use the file in same folder) -->
  <script src="fuel-moisture-calculator.js"></script>

  <script>
    // Basic map initialization so controls appear (demo)
    const map = L.map('map', { center:[37.3, -77.4], zoom:9 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OSM'
    }).addTo(map);

    // Demo toggles (visual placeholders)
    document.getElementById('toggleFires').addEventListener('click', () => {
      alert('Toggle fires (demo)');
    });
    document.getElementById('toggleCounties').addEventListener('click', () => {
      alert('Toggle counties (demo)');
    });

    // Theme toggle
    const toggle = document.getElementById('themeToggle');
    toggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      toggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
    });

    // Modal wiring (attach after DOM elements exist)
    (function(){
      function getFocusable(container){
        if(!container) return [];
        const selectors = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
        return Array.from(container.querySelectorAll(selectors)).filter(el => el.offsetWidth > 0 || el.offsetHeight > 0 || el === document.activeElement);
      }

      const openBtn = document.getElementById('openFuelCalc');
      const modal = document.getElementById('fuelCalcModal');
      const modalClose = document.getElementById('modalCloseBtn');
      let lastFocused = null;
      let keydownHandler = null;

      function openModal(){
        if(!modal) return;
        lastFocused = document.activeElement;
        modal.setAttribute('aria-hidden', 'false');
        modal.style.display = 'flex';

        // wire the calculator UI via namespace (namespaced API is deliberate)
        try {
          if (window.FuelMoistureCalculator?.wireUI) {
            window.FuelMoistureCalculator.wireUI();
          } else {
            console.warn('FuelMoistureCalculator.wireUI() not found ‚Äî calculator UI will not be wired. Available keys:', Object.keys(window.FuelMoistureCalculator || {}));
          }
        } catch (e) {
          console.warn('wireUI error', e);
        }

        // focus first meaningful element (title)
        const title = document.getElementById('fuelCalcTitle');
        if (title && typeof title.focus === 'function') title.focus();

        // trap focus
        const focusables = getFocusable(modal);
        if (focusables.length) {
          const first = focusables[0];
          const last = focusables[focusables.length - 1];
          keydownHandler = function(e){
            if (e.key === 'Tab') {
              if (e.shiftKey && document.activeElement === first) {
                e.preventDefault(); last.focus();
              } else if (!e.shiftKey && document.activeElement === last) {
                e.preventDefault(); first.focus();
              }
            } else if (e.key === 'Escape') {
              e.preventDefault(); closeModal();
            }
          };
          document.addEventListener('keydown', keydownHandler);
        }
      }

      function closeModal(){
        if(!modal) return;
        modal.setAttribute('aria-hidden', 'true');
        modal.style.display = 'none';
        if (keydownHandler) document.removeEventListener('keydown', keydownHandler);
        if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
      }

      openBtn.addEventListener('click', openModal);
      modalClose.addEventListener('click', closeModal);

      // ensure UI is wired if the page loads and elements are present
      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (window.FuelMoistureCalculator?.wireUI) window.FuelMoistureCalculator.wireUI();
        } catch(e) { /* ignore */ }
      });
    })();
  </script>
</body>
</html>
